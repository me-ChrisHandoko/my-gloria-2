generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["gloria_master", "gloria_ops"]
}

model DataKaryawan {
  nip                    String        @id @db.VarChar(15)
  nama                   String?       @db.VarChar(109)
  jenisKelamin           String?       @map("jenis_kelamin") @db.VarChar(1)
  tglMulaiBekerja        DateTime?     @map("tgl_mulai_bekerja") @db.Timestamp(6)
  tglTetap               DateTime?     @map("tgl_tetap") @db.Timestamp(6)
  status                 String?       @db.VarChar(10)
  waktuKerjaKependidikan String?       @map("waktu_kerja_kependidikan") @db.VarChar(10)
  bagianKerja            String?       @map("bagian_kerja") @db.VarChar(50)
  lokasi                 String?       @db.VarChar(20)
  bidangKerja            String?       @map("bidang_kerja") @db.VarChar(70)
  jenisKaryawan          String?       @map("jenis_karyawan") @db.VarChar(20)
  statusAktif            String?       @map("status_aktif") @db.VarChar(8)
  noPonsel               String?       @map("no_ponsel") @db.VarChar(25)
  email                  String?       @db.VarChar(100)
  birthdate              DateTime?     @db.Timestamp(6)
  rfid                   String?       @db.VarChar(100)
  userProfile            UserProfile?

  @@index([bagianKerja])
  @@index([bidangKerja])
  @@index([email])
  @@index([nip])
  @@schema("gloria_master")
  @@map("data_karyawan")
}

model ApiKey {
  id            String      @id
  name          String      @db.VarChar(255)
  keyHash       String      @unique @map("key_hash")
  prefix        String      @db.VarChar(10)
  lastFourChars String      @map("last_four_chars") @db.VarChar(4)
  algorithm     String      @default("argon2id") @db.VarChar(20)
  userId        String      @map("user_id")
  description   String?
  permissions   Json?
  rateLimit     Int?        @map("rate_limit")
  allowedIps    String[]    @map("allowed_ips")
  lastUsedAt    DateTime?   @map("last_used_at")
  lastUsedIp    String?     @map("last_used_ip") @db.VarChar(45)
  usageCount    Int         @default(0) @map("usage_count")
  expiresAt     DateTime?   @map("expires_at")
  isActive      Boolean     @default(true) @map("is_active")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @map("updated_at")
  userProfile   UserProfile @relation(fields: [userId], references: [id])

  @@index([isActive, expiresAt])
  @@index([keyHash])
  @@index([prefix])
  @@index([userId])
  @@schema("gloria_ops")
  @@map("api_keys")
}

model AuditLog {
  id                String        @id
  actorId           String        @map("actor_id")
  actorProfileId    String?       @map("actor_profile_id")
  action            AuditAction
  module            String
  entityType        String        @map("entity_type")
  entityId          String        @map("entity_id")
  entityDisplay     String?       @map("entity_display")
  oldValues         Json?         @map("old_values")
  newValues         Json?         @map("new_values")
  changedFields     Json?         @map("changed_fields")
  targetUserId      String?       @map("target_user_id")
  metadata          Json?
  ipAddress         String?       @map("ip_address")
  userAgent         String?       @map("user_agent")
  createdAt         DateTime      @default(now()) @map("created_at")
  category          AuditCategory?
  actorProfile      UserProfile?  @relation("AuditLogActorProfile", fields: [actorProfileId], references: [id])
  targetUserProfile UserProfile?  @relation("AuditLogTargetUser", fields: [targetUserId], references: [id])

  @@index([actorProfileId, module, action, createdAt(sort: Desc)])
  @@index([category, entityType, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([entityType, entityId, createdAt(sort: Desc)])
  @@schema("gloria_ops")
  @@map("audit_logs")
}

model BulkOperationProgress {
  id              String    @id
  operationType   String    @map("operation_type")
  status          String
  totalItems      Int       @map("total_items")
  processedItems  Int       @default(0) @map("processed_items")
  successfulItems Int       @default(0) @map("successful_items")
  failedItems     Int       @default(0) @map("failed_items")
  errorDetails    Json?     @map("error_details")
  rollbackData    Json?     @map("rollback_data")
  startedAt       DateTime  @default(now()) @map("started_at")
  completedAt     DateTime? @map("completed_at")
  initiatedBy     String    @map("initiated_by")
  metadata        Json?

  @@index([initiatedBy, startedAt])
  @@index([status, startedAt])
  @@schema("gloria_ops")
  @@map("bulk_operation_progress")
}

model Delegation {
  id             String         @id
  type           DelegationType
  delegatorId    String         @map("delegator_id")
  delegateId     String         @map("delegate_id")
  reason         String?
  effectiveFrom  DateTime       @default(now()) @map("effective_from")
  effectiveUntil DateTime?      @map("effective_until")
  isActive       Boolean        @default(true) @map("is_active")
  context        Json?
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @map("updated_at")
  createdBy      String?        @map("created_by")
  delegate       UserProfile    @relation("DelegationDelegate", fields: [delegateId], references: [id])
  delegator      UserProfile    @relation("DelegationDelegator", fields: [delegatorId], references: [id])

  @@index([delegateId, type, isActive])
  @@index([delegatorId, type, isActive])
  @@index([type, effectiveFrom, effectiveUntil])
  @@schema("gloria_ops")
  @@map("delegations")
}

model Department {
  id          String       @id
  code        String       @unique
  name        String
  schoolId    String?      @map("school_id")
  parentId    String?      @map("parent_id")
  description String?
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @map("updated_at")
  createdBy   String?      @map("created_by")
  modifiedBy  String?      @map("modified_by")
  parent      Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children    Department[] @relation("DepartmentHierarchy")
  school      School?      @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  positions   Position[]

  @@index([parentId])
  @@index([schoolId, isActive])
  @@index([createdBy])
  @@schema("gloria_ops")
  @@map("departments")
}

model FeatureFlagEvaluation {
  id            String      @id
  featureFlagId String      @map("feature_flag_id")
  userId        String?     @map("user_id")
  result        Boolean
  reason        String
  context       Json?
  evaluatedAt   DateTime    @default(now()) @map("evaluated_at")
  featureFlag   FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)

  @@index([evaluatedAt])
  @@index([featureFlagId])
  @@index([userId])
  @@schema("gloria_ops")
  @@map("feature_flag_evaluations")
}

model FeatureFlag {
  id                       String                   @id
  key                      String                   @unique
  name                     String
  description              String?
  type                     String
  enabled                  Boolean                  @default(false)
  defaultValue             Json?                    @map("default_value")
  rolloutPercentage        Int                      @default(0) @map("rollout_percentage")
  conditions               Json?
  targetUsers              String[]                 @map("target_users")
  targetRoles              String[]                 @map("target_roles")
  targetSchools            String[]                 @map("target_schools")
  startDate                DateTime?                @map("start_date")
  endDate                  DateTime?                @map("end_date")
  metadata                 Json?
  createdAt                DateTime                 @default(now()) @map("created_at")
  updatedAt                DateTime                 @map("updated_at")
  createdBy                String?                  @map("created_by")
  featureFlagEvaluations   FeatureFlagEvaluation[]

  @@index([enabled])
  @@index([key])
  @@index([type])
  @@schema("gloria_ops")
  @@map("feature_flags")
}

model ModulePermission {
  id          String           @id
  moduleId    String           @map("module_id")
  action      PermissionAction
  scope       PermissionScope
  description String?
  module      Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([moduleId, action, scope])
  @@schema("gloria_ops")
  @@map("module_permissions")
}

model Module {
  id                String             @id
  code              String             @unique
  name              String
  category          ModuleCategory
  description       String?
  icon              String?
  path              String?
  parentId          String?            @map("parent_id")
  sortOrder         Int                @default(0) @map("sort_order")
  isActive          Boolean            @default(true) @map("is_active")
  isVisible         Boolean            @default(true) @map("is_visible")
  version           Int                @default(0)
  deletedAt         DateTime?          @map("deleted_at")
  deletedBy         String?            @map("deleted_by")
  deleteReason      String?            @map("delete_reason")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @map("updated_at")
  createdBy         String?            @map("created_by")
  updatedBy         String?            @map("updated_by")
  modulePermissions ModulePermission[]
  parent            Module?            @relation("ModuleHierarchy", fields: [parentId], references: [id])
  children          Module[]           @relation("ModuleHierarchy")
  roleModuleAccess  RoleModuleAccess[]
  userModuleAccess  UserModuleAccess[]

  @@index([code])
  @@index([isActive])
  @@index([category, isActive])
  @@index([deletedAt])
  @@index([id, version])
  @@index([isVisible, isActive])
  @@index([parentId, isActive, sortOrder])
  @@schema("gloria_ops")
  @@map("modules")
}

model Permission {
  id                 String           @id
  code               String           @unique
  name               String
  description        String?
  resource           String
  action             PermissionAction
  scope              PermissionScope?
  conditions         Json?
  metadata           Json?
  isSystemPermission Boolean          @default(false) @map("is_system_permission")
  isActive           Boolean          @default(true) @map("is_active")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @map("updated_at")
  createdBy          String?          @map("created_by")
  category           ModuleCategory?
  groupIcon          String?          @map("group_icon")
  groupName          String?          @map("group_name")
  groupSortOrder     Int?             @default(0) @map("group_sort_order")
  rolePermissions    RolePermission[]
  userPermissions    UserPermission[]

  @@unique([resource, action, scope])
  @@index([action])
  @@index([resource])
  @@index([category, isActive])
  @@index([resource, action])
  @@schema("gloria_ops")
  @@map("permissions")
}

model PositionHierarchy {
  id            String    @id
  positionId    String    @unique @map("position_id")
  reportsToId   String?   @map("reports_to_id")
  coordinatorId String?   @map("coordinator_id")
  coordinator   Position? @relation("PositionCoordinator", fields: [coordinatorId], references: [id])
  position      Position  @relation("PositionHierarchy", fields: [positionId], references: [id], onDelete: Cascade)
  reportsTo     Position? @relation("PositionReportsTo", fields: [reportsToId], references: [id])

  @@index([coordinatorId])
  @@index([reportsToId])
  @@schema("gloria_ops")
  @@map("position_hierarchy")
}

model Position {
  id                   String              @id
  code                 String              @unique
  name                 String
  departmentId         String?             @map("department_id")
  schoolId             String?             @map("school_id")
  hierarchyLevel       Int                 @map("hierarchy_level")
  maxHolders           Int                 @default(1) @map("max_holders")
  isUnique             Boolean             @default(true) @map("is_unique")
  isActive             Boolean             @default(true) @map("is_active")
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @map("updated_at")
  createdBy            String?             @map("created_by")
  modifiedBy           String?             @map("modified_by")
  coordinatorPositions PositionHierarchy[] @relation("PositionCoordinator")
  positionHierarchy    PositionHierarchy?  @relation("PositionHierarchy")
  reportsToPositions   PositionHierarchy[] @relation("PositionReportsTo")
  department           Department?         @relation(fields: [departmentId], references: [id])
  school               School?             @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  roleModuleAccess     RoleModuleAccess[]
  userPositions        UserPosition[]

  @@index([departmentId, hierarchyLevel, isActive])
  @@index([schoolId, departmentId, hierarchyLevel, isActive])
  @@schema("gloria_ops")
  @@map("positions")
}

model RoleHierarchy {
  id                 String   @id
  roleId             String   @map("role_id")
  parentRoleId       String   @map("parent_role_id")
  inheritPermissions Boolean  @default(true) @map("inherit_permissions")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @map("updated_at")
  parentRole         Role     @relation("RoleHierarchyParent", fields: [parentRoleId], references: [id], onDelete: Cascade)
  role               Role     @relation("RoleHierarchyRole", fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, parentRoleId])
  @@index([parentRoleId])
  @@schema("gloria_ops")
  @@map("role_hierarchy")
}

model RoleModuleAccess {
  id          String    @id
  roleId      String    @map("role_id")
  moduleId    String    @map("module_id")
  positionId  String?   @map("position_id")
  permissions Json
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @map("updated_at")
  createdBy   String?   @map("created_by")
  version     Int       @default(0)
  module      Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  position    Position? @relation(fields: [positionId], references: [id])
  role        Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, moduleId])
  @@index([isActive])
  @@index([moduleId])
  @@index([roleId])
  @@index([id, version])
  @@schema("gloria_ops")
  @@map("role_module_access")
}

model RolePermission {
  id             String     @id
  roleId         String     @map("role_id")
  permissionId   String     @map("permission_id")
  isGranted      Boolean    @default(true) @map("is_granted")
  conditions     Json?
  grantedBy      String?    @map("granted_by")
  grantReason    String?    @map("grant_reason")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @map("updated_at")
  effectiveFrom  DateTime   @default(now()) @map("effective_from")
  effectiveUntil DateTime?  @map("effective_until")
  permission     Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role           Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([permissionId])
  @@index([roleId, isGranted])
  @@schema("gloria_ops")
  @@map("role_permissions")
}

model Role {
  id               String             @id
  code             String             @unique
  name             String
  description      String?
  hierarchyLevel   Int                @map("hierarchy_level")
  isSystemRole     Boolean            @default(false) @map("is_system_role")
  isActive         Boolean            @default(true) @map("is_active")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @map("updated_at")
  createdBy        String?            @map("created_by")
  parentRoles      RoleHierarchy[]    @relation("RoleHierarchyParent")
  childRoles       RoleHierarchy[]    @relation("RoleHierarchyRole")
  roleModuleAccess RoleModuleAccess[]
  rolePermissions  RolePermission[]
  userRoles        UserRole[]

  @@index([hierarchyLevel])
  @@schema("gloria_ops")
  @@map("roles")
}

model School {
  id          String       @id
  code        String       @unique
  name        String
  lokasi      String?
  address     String?
  phone       String?
  email       String?
  principal   String?
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @map("updated_at")
  createdBy   String?      @map("created_by")
  modifiedBy  String?      @map("modified_by")
  departments Department[]
  positions   Position[]

  @@index([createdBy])
  @@index([lokasi, isActive])
  @@schema("gloria_ops")
  @@map("schools")
}

model SystemConfiguration {
  id              String   @id
  key             String   @unique
  value           Json
  type            String
  category        String
  description     String?
  isEncrypted     Boolean  @default(false) @map("is_encrypted")
  isPublic        Boolean  @default(false) @map("is_public")
  metadata        Json?
  validationRules Json?    @map("validation_rules")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @map("updated_at")
  updatedBy       String?  @map("updated_by")

  @@index([category])
  @@index([isPublic])
  @@index([key])
  @@schema("gloria_ops")
  @@map("system_configurations")
}

model UserModuleAccess {
  id             String      @id
  userProfileId  String      @map("user_profile_id")
  moduleId       String      @map("module_id")
  permissions    Json
  grantedBy      String      @map("granted_by")
  reason         String?
  isActive       Boolean     @default(true) @map("is_active")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @map("updated_at")
  version        Int         @default(0)
  effectiveFrom  DateTime    @default(now()) @map("effective_from")
  effectiveUntil DateTime?   @map("effective_until")
  module         Module      @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  userProfile    UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)

  @@index([userProfileId, moduleId, isActive])
  @@index([id, version])
  @@index([isActive])
  @@schema("gloria_ops")
  @@map("user_module_access")
}

model UserPermission {
  id             String      @id
  userProfileId  String      @map("user_profile_id")
  permissionId   String      @map("permission_id")
  isGranted      Boolean     @default(true) @map("is_granted")
  conditions     Json?
  grantedBy      String      @map("granted_by")
  grantReason    String      @map("grant_reason")
  priority       Int         @default(100)
  isTemporary    Boolean     @default(false) @map("is_temporary")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @map("updated_at")
  resourceId     String?     @map("resource_id")
  resourceType   String?     @map("resource_type")
  effectiveFrom  DateTime    @default(now()) @map("effective_from")
  effectiveUntil DateTime?   @map("effective_until")
  permission     Permission  @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  userProfile    UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)

  @@unique([userProfileId, permissionId, resourceType, resourceId])
  @@index([userProfileId])
  @@index([effectiveFrom, effectiveUntil])
  @@index([permissionId])
  @@index([resourceType, resourceId])
  @@index([userProfileId, isGranted])
  @@schema("gloria_ops")
  @@map("user_permissions")
}

model UserPosition {
  id              String      @id
  userProfileId   String      @map("user_profile_id")
  positionId      String      @map("position_id")
  startDate       DateTime    @map("start_date")
  endDate         DateTime?   @map("end_date")
  isActive        Boolean     @default(true) @map("is_active")
  isPlt           Boolean     @default(false) @map("is_plt")
  appointedBy     String?     @map("appointed_by")
  skNumber        String?     @map("sk_number")
  notes           String?
  permissionScope String?     @map("permission_scope")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @map("updated_at")
  position        Position    @relation(fields: [positionId], references: [id])
  userProfile     UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)

  @@unique([userProfileId, positionId, startDate])
  @@index([positionId, isActive, startDate, endDate])
  @@index([userProfileId, isActive, startDate, endDate])
  @@schema("gloria_ops")
  @@map("user_positions")
}

model UserProfile {
  id                     String             @id
  clerkUserId            String             @unique @map("clerk_user_id")
  nip                    String             @unique @db.VarChar(15)
  isActive               Boolean            @default(true) @map("is_active")
  lastActive             DateTime?          @map("last_active")
  preferences            Json?
  createdAt              DateTime           @default(now()) @map("created_at")
  updatedAt              DateTime           @map("updated_at")
  createdBy              String?            @map("created_by")
  apiKeys                ApiKey[]
  actorAuditLogs         AuditLog[]         @relation("AuditLogActorProfile")
  targetAuditLogs        AuditLog[]         @relation("AuditLogTargetUser")
  delegationsAsDelegate  Delegation[]       @relation("DelegationDelegate")
  delegationsAsDelegator Delegation[]       @relation("DelegationDelegator")
  userModuleAccess       UserModuleAccess[]
  userPermissions        UserPermission[]
  userPositions          UserPosition[]
  dataKaryawan           DataKaryawan       @relation(fields: [nip], references: [nip])
  userRoles              UserRole[]

  @@index([clerkUserId, isActive])
  @@index([nip, isActive])
  @@schema("gloria_ops")
  @@map("user_profiles")
}

model UserRole {
  id             String      @id
  userProfileId  String      @map("user_profile_id")
  roleId         String      @map("role_id")
  assignedAt     DateTime    @default(now()) @map("assigned_at")
  assignedBy     String?     @map("assigned_by")
  isActive       Boolean     @default(true) @map("is_active")
  effectiveFrom  DateTime    @default(now()) @map("effective_from")
  effectiveUntil DateTime?   @map("effective_until")
  role           Role        @relation(fields: [roleId], references: [id])
  userProfile    UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)

  @@unique([userProfileId, roleId])
  @@index([roleId])
  @@index([userProfileId])
  @@index([userProfileId, isActive])
  @@schema("gloria_ops")
  @@map("user_roles")
}

model Workflow {
  id                 String    @id
  completedAt        DateTime? @map("completed_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  initiatorId        String?   @map("initiator_id") @db.VarChar(255)
  metadata           Json?
  requestId          String    @unique @map("request_id") @db.VarChar(255)
  startedAt          DateTime  @default(now()) @map("started_at")
  status             String    @db.VarChar(50)
  temporalRunId      String?   @map("temporal_run_id") @db.VarChar(255)
  temporalWorkflowId String?   @map("temporal_workflow_id") @db.VarChar(255)
  workflowType       String    @map("workflow_type") @db.VarChar(100)

  @@index([initiatorId])
  @@index([startedAt(sort: Desc)])
  @@index([status])
  @@index([temporalWorkflowId])
  @@index([workflowType])
  @@schema("gloria_ops")
  @@map("workflow")
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  APPROVE
  REJECT
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
  ASSIGN
  GRANT
  REVOKE
  DELEGATE

  @@schema("gloria_ops")
}

enum AuditCategory {
  PERMISSION
  MODULE
  WORKFLOW
  SYSTEM_CONFIG
  USER_MANAGEMENT
  DATA_CHANGE

  @@schema("gloria_ops")
}

enum DelegationType {
  APPROVAL
  PERMISSION
  WORKFLOW

  @@schema("gloria_ops")
}

enum ModuleCategory {
  SERVICE
  PERFORMANCE
  QUALITY
  FEEDBACK
  TRAINING
  SYSTEM

  @@schema("gloria_ops")
}

enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  APPROVE
  EXPORT
  IMPORT
  PRINT
  ASSIGN
  CLOSE

  @@schema("gloria_ops")
}

enum PermissionScope {
  OWN
  DEPARTMENT
  SCHOOL
  ALL

  @@schema("gloria_ops")
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
  CRITICAL

  @@schema("gloria_ops")
}
