â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PHASE 3 IMPLEMENTATION GUIDE: TEMPORAL.IO WORKFLOW MIGRATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Status: âœ… IMPLEMENTATION COMPLETE - READY FOR DEPLOYMENT

This guide documents the Phase 3 implementation that replaces the custom
workflow engine (11 tables) with Temporal.io, reducing complexity by 90%.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ WHAT WAS IMPLEMENTED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. âœ… Temporal.io Infrastructure
   - Docker Compose configuration for Temporal server + UI
   - PostgreSQL database for Temporal persistence
   - Network configuration and health checks

2. âœ… Temporal SDK Integration
   - Installed @temporalio/* packages
   - Created NestJS service integration
   - Worker process for executing workflows

3. âœ… Workflow Implementation
   - Approval workflow with escalation logic
   - Simple approval workflow (no escalation)
   - Activity functions for notifications, approvals, audit logs

4. âœ… Migration Tooling
   - Script to migrate active workflows from old system
   - Dry-run capability for testing
   - Progress tracking and error handling

5. âœ… Database Schema Changes
   - SQL migration to remove 11 old workflow tables
   - New simplified WorkflowHistory table for audit
   - Cleanup of foreign key constraints

6. âœ… Testing Suite
   - Workflow tests using Temporal test environment
   - Activity unit tests
   - Integration test examples

7. âœ… Documentation & Scripts
   - Worker startup script
   - Environment configuration
   - Deployment guides

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ DEPLOYMENT STEPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STEP 1: Setup Environment Variables
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Add to your .env file:

TEMPORAL_ADDRESS=localhost:7233
TEMPORAL_NAMESPACE=default
TEMPORAL_TASK_QUEUE=gloria-workflows
TEMPORAL_UI_URL=http://localhost:8233


STEP 2: Start Temporal Infrastructure
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cd /path/to/backend

# Start Temporal server, UI, and PostgreSQL
docker-compose -f docker-compose.temporal.yml up -d

# Verify Temporal is running
curl http://localhost:8233  # Should show Temporal UI

# Check logs
docker logs gloria-temporal


STEP 3: Migrate Active Workflows (DRY RUN FIRST)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# First, run in dry-run mode to see what will be migrated
npx ts-node scripts/migrations/migrate-workflows-to-temporal.ts --dry-run

# Review the output, then run actual migration
npx ts-node scripts/migrations/migrate-workflows-to-temporal.ts

Expected output:
  - Total workflows found
  - Migration progress
  - Success/failure counts


STEP 4: Run Database Migration
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# âš ï¸ CRITICAL: Backup database first!
pg_dump $DATABASE_URL > backup_pre_phase3.sql

# Run the migration SQL
psql $DATABASE_URL < prisma/migrations/phase3-temporal-migration.sql

# Verify migration success
psql $DATABASE_URL -c "SELECT COUNT(*) FROM gloria_ops.workflow_history;"


STEP 5: Start Temporal Worker
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# In a separate terminal, start the worker
./scripts/start-temporal-worker.sh

# Or run directly:
npx ts-node src/temporal/worker.ts

Expected output:
  âœ“ Connected to Temporal
  âœ“ Worker started, polling for tasks...


STEP 6: Update Application Code
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Add TemporalModule to your AppModule
Edit src/app.module.ts:

import { TemporalModule } from './temporal/temporal.module';

@Module({
  imports: [
    // ... existing imports
    TemporalModule,
  ],
})
export class AppModule {}


STEP 7: Update Workflow Controllers
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Replace old workflow service calls with Temporal service:

import { TemporalService } from './temporal/temporal.service';

@Controller('approvals')
export class ApprovalsController {
  constructor(private temporalService: TemporalService) {}

  @Post()
  async createApproval(@Body() dto: CreateApprovalDto) {
    const request: ApprovalRequest = {
      id: generateId(),
      requestId: dto.requestId,
      initiatorId: dto.userId,
      approverId: dto.approverId,
      module: dto.module,
      entityType: dto.entityType,
      entityId: dto.entityId,
      priority: dto.priority,
    };

    const { workflowId, runId } = await this.temporalService
      .startApprovalWorkflow(request);

    return {
      workflowId,
      runId,
      status: 'STARTED',
    };
  }

  @Get(':workflowId/status')
  async getStatus(@Param('workflowId') workflowId: string) {
    return this.temporalService.getWorkflowStatus(workflowId);
  }
}


STEP 8: Run Tests
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

npm run test src/temporal/__tests__/approval.workflow.test.ts


STEP 9: Monitor & Verify
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Access Temporal UI: http://localhost:8233
2. Check workflow executions
3. Monitor worker logs
4. Verify WorkflowHistory table populates correctly


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š EXPECTED OUTCOMES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Database Complexity Reduction:
  âŒ Workflow              (removed)
  âŒ WorkflowTemplate      (removed)
  âŒ WorkflowInstance      (removed)
  âŒ WorkflowStepInstance  (removed)
  âŒ WorkflowAction        (removed)
  âŒ WorkflowDelegation    (removed)
  âŒ WorkflowEscalation    (removed)
  âŒ WorkflowTransition    (removed)
  âŒ WorkflowHistory (old) (removed)

  âœ… WorkflowHistory (new) (1 simple audit table)

Reduction: 11 tables â†’ 1 table (90% reduction)

Performance Improvements:
  - Workflow execution handled by production-grade Temporal
  - No more complex SQL joins for workflow state
  - Built-in retry, timeout, versioning capabilities
  - Time-travel debugging via Temporal UI

Maintenance Benefits:
  - No custom workflow engine code to maintain
  - Temporal team handles infrastructure updates
  - Easy to add new workflow types
  - Better observability and monitoring


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ TROUBLESHOOTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Issue: "Cannot connect to Temporal"
Solution:
  - Check Docker containers: docker ps | grep temporal
  - Check logs: docker logs gloria-temporal
  - Verify port 7233 is not blocked
  - Restart: docker-compose -f docker-compose.temporal.yml restart

Issue: "Worker not processing workflows"
Solution:
  - Check worker logs for errors
  - Verify TEMPORAL_ADDRESS and TEMPORAL_NAMESPACE
  - Ensure task queue name matches: "gloria-workflows"
  - Restart worker

Issue: "Migration script fails"
Solution:
  - Run with --dry-run first
  - Check database connection
  - Verify Temporal is running and accessible
  - Check logs for specific error messages

Issue: "Old workflow data lost"
Solution:
  - Restore from backup: psql $DATABASE_URL < backup_pre_phase3.sql
  - Re-run migration with fixes
  - Contact DBA for assistance


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ›¡ï¸ ROLLBACK PROCEDURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

If issues occur, rollback as follows:

1. Stop Temporal worker
   pkill -f "temporal/worker.ts"

2. Stop Temporal infrastructure
   docker-compose -f docker-compose.temporal.yml down

3. Restore database backup
   psql $DATABASE_URL < backup_pre_phase3.sql

4. Revert application code changes
   git revert <commit-hash>

5. Restart application
   npm run start:dev


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ FILE STRUCTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

backend/
â”œâ”€â”€ docker-compose.temporal.yml          # Temporal infrastructure
â”œâ”€â”€ src/
â”‚   â””â”€â”€ temporal/
â”‚       â”œâ”€â”€ activities/
â”‚       â”‚   â”œâ”€â”€ approval.activities.ts   # Approval-related activities
â”‚       â”‚   â”œâ”€â”€ notification.activities.ts # Notification activities
â”‚       â”‚   â””â”€â”€ index.ts
â”‚       â”œâ”€â”€ workflows/
â”‚       â”‚   â”œâ”€â”€ approval.workflow.ts     # Workflow definitions
â”‚       â”‚   â””â”€â”€ index.ts
â”‚       â”œâ”€â”€ types/
â”‚       â”‚   â””â”€â”€ workflow.types.ts        # TypeScript interfaces
â”‚       â”œâ”€â”€ temporal.service.ts          # NestJS service integration
â”‚       â”œâ”€â”€ temporal.module.ts           # NestJS module
â”‚       â”œâ”€â”€ worker.ts                    # Worker process
â”‚       â””â”€â”€ __tests__/
â”‚           â””â”€â”€ approval.workflow.test.ts # Tests
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ migrate-workflows-to-temporal.ts # Migration script
â”‚   â””â”€â”€ start-temporal-worker.sh         # Worker startup script
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ phase3-temporal-migration.sql # Database migration
â”‚   â””â”€â”€ schema-phase3-temporal.prisma    # New schema definition
â””â”€â”€ PHASE3-IMPLEMENTATION-GUIDE.txt      # This file


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… SUCCESS CRITERIA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Phase 3 is successful when:

â˜‘ Temporal infrastructure running (docker ps shows 3 containers)
â˜‘ Temporal UI accessible at http://localhost:8233
â˜‘ Worker process running without errors
â˜‘ New approval requests create Temporal workflows
â˜‘ Workflows visible in Temporal UI
â˜‘ WorkflowHistory table populating correctly
â˜‘ Old workflow tables removed from database
â˜‘ All tests passing
â˜‘ No errors in application logs
â˜‘ Rollback procedure tested and documented


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ SUPPORT & NEXT STEPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Questions or Issues?
1. Check troubleshooting section above
2. Review Temporal docs: https://docs.temporal.io
3. Check worker and server logs
4. Consult with DBA or senior developer

After Successful Deployment:
1. Monitor system for 1 week
2. Collect performance metrics
3. Document any edge cases found
4. Train team on Temporal UI usage
5. Plan Phase 4: Data Normalization


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Document Version: 1.0
Last Updated: 2025-10-29
Status: âœ… Ready for Deployment
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
